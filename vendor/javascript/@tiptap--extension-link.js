// @tiptap/extension-link@3.13.0 downloaded from https://ga.jspm.io/npm:@tiptap/extension-link@3.13.0/dist/index.js

import{combineTransactionSteps as t,getChangedRanges as e,findChildrenInRange as o,getMarksBetween as n,getAttributes as i,Mark as s,markPasteRule as r,mergeAttributes as l}from"@tiptap/core";import{tokenize as a,find as u,reset as p,registerCustomProtocol as c}from"linkifyjs";import{Plugin as d,PluginKey as h}from"@tiptap/pm/state";var f="[\0-   ᠎ -\u2029 　]";var k=new RegExp(f);var m=new RegExp(`${f}$`);var g=new RegExp(f,"g");function A(t){return t.length===1?t[0].isLink:!(t.length!==3||!t[1].isLink)&&["()","[]"].includes(t[0].value+t[2].value)}function v(i){return new d({key:new h("autolink"),appendTransaction:(s,r,l)=>{const u=s.some((t=>t.docChanged))&&!r.doc.eq(l.doc);const p=s.some((t=>t.getMeta("preventAutolink")));if(!u||p)return;const{tr:c}=l;const d=t(r.doc,[...s]);const h=e(d);h.forEach((({newRange:t})=>{const e=o(l.doc,t,(t=>t.isTextblock));let s;let r;if(e.length>1){s=e[0];r=l.doc.textBetween(s.pos,s.pos+s.node.nodeSize,void 0," ")}else if(e.length){const o=l.doc.textBetween(t.from,t.to," "," ");if(!m.test(o))return;s=e[0];r=l.doc.textBetween(s.pos,t.to,void 0," ")}if(s&&r){const t=r.split(k).filter(Boolean);if(t.length<=0)return false;const e=t[t.length-1];const o=s.pos+r.lastIndexOf(e);if(!e)return false;const u=a(e).map((t=>t.toObject(i.defaultProtocol)));if(!A(u))return false;u.filter((t=>t.isLink)).map((t=>({...t,from:o+t.start+1,to:o+t.end+1}))).filter((t=>!l.schema.marks.code||!l.doc.rangeHasMark(t.from,t.to,l.schema.marks.code))).filter((t=>i.validate(t.value))).filter((t=>i.shouldAutoLink(t.value))).forEach((t=>{n(t.from,t.to,l.doc).some((t=>t.mark.type===i.type))||c.addMark(t.from,t.to,i.type.create({href:t.href}))}))}}));return c.steps.length?c:void 0}})}function w(t){return new d({key:new h("handleClickLink"),props:{handleClick:(e,o,n)=>{var s,r;if(n.button!==0)return false;if(!e.editable)return false;let l=false;if(t.enableClickSelection){const e=t.editor.commands.extendMarkRange(t.type.name);l=e}if(t.openOnClick){let o=null;if(n.target instanceof HTMLAnchorElement)o=n.target;else{let t=n.target;const e=[];while(t.nodeName!=="DIV"){e.push(t);t=t.parentNode}o=e.find((t=>t.nodeName==="A"))}if(!o)return l;const a=i(e.state,t.type.name);const u=(s=o==null?void 0:o.href)!=null?s:a.href;const p=(r=o==null?void 0:o.target)!=null?r:a.target;if(o&&u){window.open(u,p);l=true}}return l}}})}function L(t){return new d({key:new h("handlePasteLink"),props:{handlePaste:(e,o,n)=>{const{shouldAutoLink:i}=t;const{state:s}=e;const{selection:r}=s;const{empty:l}=r;if(l)return false;let a="";n.content.forEach((t=>{a+=t.textContent}));const p=u(a,{defaultProtocol:t.defaultProtocol}).find((t=>t.isLink&&t.value===a));return!(!a||!p||i!==void 0&&!i(p.href))&&t.editor.commands.setMark(t.type,{href:p.href})}}})}var M=/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z]{2,}\b(?:[-a-zA-Z0-9@:%._+~#=?!&/]*)(?:[-a-zA-Z0-9@:%._+~#=?!&/]*)/gi;function P(t,e){const o=["http","https","ftp","ftps","mailto","tel","callto","sms","cid","xmpp"];e&&e.forEach((t=>{const e=typeof t==="string"?t:t.scheme;e&&o.push(e)}));return!t||t.replace(g,"").match(new RegExp(`^(?:(?:${o.join("|")}):|[^a-z]|[a-z0-9+.-]+(?:[^a-z+.-:]|$))`,"i"))}var y=s.create({name:"link",priority:1e3,keepOnSplit:false,exitable:true,onCreate(){if(this.options.validate&&!this.options.shouldAutoLink){this.options.shouldAutoLink=this.options.validate;console.warn("The `validate` option is deprecated. Rename to the `shouldAutoLink` option instead.")}this.options.protocols.forEach((t=>{typeof t!=="string"?c(t.scheme,t.optionalSlashes):c(t)}))},onDestroy(){p()},inclusive(){return this.options.autolink},addOptions(){return{openOnClick:true,enableClickSelection:false,linkOnPaste:true,autolink:true,protocols:[],defaultProtocol:"http",HTMLAttributes:{target:"_blank",rel:"noopener noreferrer nofollow",class:null},isAllowedUri:(t,e)=>!!P(t,e.protocols),validate:t=>!!t,shouldAutoLink:t=>!!t}},addAttributes(){return{href:{default:null,parseHTML(t){return t.getAttribute("href")}},target:{default:this.options.HTMLAttributes.target},rel:{default:this.options.HTMLAttributes.rel},class:{default:this.options.HTMLAttributes.class}}},parseHTML(){return[{tag:"a[href]",getAttrs:t=>{const e=t.getAttribute("href");return!(!e||!this.options.isAllowedUri(e,{defaultValidate:t=>!!P(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol}))&&null}}]},renderHTML({HTMLAttributes:t}){return this.options.isAllowedUri(t.href,{defaultValidate:t=>!!P(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})?["a",l(this.options.HTMLAttributes,t),0]:["a",l(this.options.HTMLAttributes,{...t,href:""}),0]},markdownTokenName:"link",parseMarkdown:(t,e)=>e.applyMark("link",e.parseInline(t.tokens||[]),{href:t.href,title:t.title||null}),renderMarkdown:(t,e)=>{var o;const n=((o=t.attrs)==null?void 0:o.href)||"";const i=e.renderChildren(t);return`[${i}](${n})`},addCommands(){return{setLink:t=>({chain:e})=>{const{href:o}=t;return!!this.options.isAllowedUri(o,{defaultValidate:t=>!!P(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol})&&e().setMark(this.name,t).setMeta("preventAutolink",true).run()},toggleLink:t=>({chain:e})=>{const{href:o}=t||{};return!(o&&!this.options.isAllowedUri(o,{defaultValidate:t=>!!P(t,this.options.protocols),protocols:this.options.protocols,defaultProtocol:this.options.defaultProtocol}))&&e().toggleMark(this.name,t,{extendEmptyMarkRange:true}).setMeta("preventAutolink",true).run()},unsetLink:()=>({chain:t})=>t().unsetMark(this.name,{extendEmptyMarkRange:true}).setMeta("preventAutolink",true).run()}},addPasteRules(){return[r({find:t=>{const e=[];if(t){const{protocols:o,defaultProtocol:n}=this.options;const i=u(t).filter((t=>t.isLink&&this.options.isAllowedUri(t.value,{defaultValidate:t=>!!P(t,o),protocols:o,defaultProtocol:n})));i.length&&i.forEach((t=>{this.options.shouldAutoLink(t.value)&&e.push({text:t.value,data:{href:t.href},index:t.start})}))}return e},type:this.type,getAttributes:t=>{var e;return{href:(e=t.data)==null?void 0:e.href}}})]},addProseMirrorPlugins(){const t=[];const{protocols:e,defaultProtocol:o}=this.options;this.options.autolink&&t.push(v({type:this.type,defaultProtocol:this.options.defaultProtocol,validate:t=>this.options.isAllowedUri(t,{defaultValidate:t=>!!P(t,e),protocols:e,defaultProtocol:o}),shouldAutoLink:this.options.shouldAutoLink}));t.push(w({type:this.type,editor:this.editor,openOnClick:this.options.openOnClick==="whenNotEditable"||this.options.openOnClick,enableClickSelection:this.options.enableClickSelection}));this.options.linkOnPaste&&t.push(L({editor:this.editor,defaultProtocol:this.options.defaultProtocol,type:this.type,shouldAutoLink:this.options.shouldAutoLink}));return t}});var b=y;export{y as Link,b as default,P as isAllowedUri,M as pasteRegex};

