// @tiptap/extension-collaboration@3.13.0 downloaded from https://ga.jspm.io/npm:@tiptap/extension-collaboration@3.13.0/dist/index.js

import{MappablePosition as t,getUpdatedPosition as e,Extension as o}from"@tiptap/core";import{Plugin as n,PluginKey as i}from"@tiptap/pm/state";import{ySyncPluginKey as r,relativePositionToAbsolutePosition as s,absolutePositionToRelativePosition as a,yUndoPlugin as d,yUndoPluginKey as c,ySyncPlugin as l,yXmlFragmentToProsemirrorJSON as p,redo as u,undo as h}from"@tiptap/y-tiptap";function m(t){return!!t.getMeta(r)}function f(t,e){const o=r.getState(t);return s(o.doc,o.type,e,o.binding.mapping)||0}function g(t,e){const o=r.getState(t);return a(e,o.type,o.binding.mapping)}var v=class _CollaborationMappablePosition extends t{constructor(t,e){super(t);this.yRelativePosition=e}static fromJSON(t){return new _CollaborationMappablePosition(t.position,t.yRelativePosition)}toJSON(){return{position:this.position,yRelativePosition:this.yRelativePosition}}};function y(t,e){const o=g(e,t);return new v(t,o)}function b(t,o,n){const i=t instanceof v?t.yRelativePosition:null;if(m(o)&&i){const t=f(n,i);return{position:new v(t,i),mapResult:null}}const r=e(t,o);const s=r.position.position;return{position:new v(s,i!=null?i:g(n,s)),mapResult:r.mapResult}}var M=o.create({name:"collaboration",priority:1e3,addOptions(){return{document:null,field:"default",fragment:null,provider:null}},addStorage(){return{isDisabled:false}},onCreate(){this.editor.extensionManager.extensions.find((t=>t.name==="undoRedo"))&&console.warn('[tiptap warn]: "@tiptap/extension-collaboration" comes with its own history support and is not compatible with "@tiptap/extension-undo-redo".')},onBeforeCreate(){this.editor.utils.getUpdatedPosition=(t,e)=>b(t,e,this.editor.state);this.editor.utils.createMappablePosition=t=>y(t,this.editor.state)},addCommands(){return{undo:()=>({tr:t,state:e,dispatch:o})=>{t.setMeta("preventDispatch",true);const n=c.getState(e).undoManager;return n.undoStack.length!==0&&(!o||h(e))},redo:()=>({tr:t,state:e,dispatch:o})=>{t.setMeta("preventDispatch",true);const n=c.getState(e).undoManager;return n.redoStack.length!==0&&(!o||u(e))}}},addKeyboardShortcuts(){return{"Mod-z":()=>this.editor.commands.undo(),"Mod-y":()=>this.editor.commands.redo(),"Shift-Mod-z":()=>this.editor.commands.redo()}},addProseMirrorPlugins(){var t;const e=this.options.fragment?this.options.fragment:this.options.document.getXmlFragment(this.options.field);const o=d(this.options.yUndoOptions);const r=o.spec.view;o.spec.view=t=>{const{undoManager:e}=c.getState(t.state);if(e.restore){e.restore();e.restore=()=>{}}const o=r?r(t):void 0;return{destroy:()=>{const t=e.trackedOrigins.has(e);const n=e._observers;e.restore=()=>{t&&e.trackedOrigins.add(e);e.doc.on("afterTransaction",e.afterTransactionHandler);e._observers=n};(o==null?void 0:o.destroy)&&o.destroy()}}};const s={...this.options.ySyncOptions,onFirstRender:this.options.onFirstRender};const a=l(e,s);this.editor.options.enableContentCheck&&((t=e.doc)==null?void 0:t.on("beforeTransaction",(()=>{try{const t=p(e);if(t.content.length===0)return;this.editor.schema.nodeFromJSON(t).check()}catch(t){this.editor.emit("contentError",{error:t,editor:this.editor,disableCollaboration:()=>{var t;(t=e.doc)==null?void 0:t.destroy();this.storage.isDisabled=true}});return false}})));return[a,o,this.editor.options.enableContentCheck&&new n({key:new i("filterInvalidContent"),filterTransaction:()=>{var t;if(this.storage.isDisabled!==false){(t=e.doc)==null?void 0:t.destroy();return true}return true}})].filter(Boolean)}});var S=M;export{M as Collaboration,v as CollaborationMappablePosition,y as createMappablePosition,S as default,b as getUpdatedPosition,m as isChangeOrigin};

