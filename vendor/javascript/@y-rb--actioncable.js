// @y-rb/actioncable@0.3.0 downloaded from https://ga.jspm.io/npm:@y-rb/actioncable@0.3.0/dist/actioncable.esm.js

import{writeVarUint as e,writeVarUint8Array as n,length as t,toUint8Array as s,createEncoder as i}from"lib0/encoding";import{readVarUint8Array as r,createDecoder as a,readVarUint as o}from"lib0/decoding";import{readSyncMessage as c,messageYjsSyncStep2 as d,writeUpdate as h,writeSyncStep1 as u,writeSyncStep2 as l}from"y-protocols/sync";import{encodeAwarenessUpdate as f,applyAwarenessUpdate as v,Awareness as p,removeAwarenessStates as b}from"y-protocols/awareness";import{readAuthMessage as w}from"y-protocols/auth";import{publish as y,subscribe as m,unsubscribe as A}from"lib0/broadcastchannel";function S(e,n){for(var t=0;t<n.length;t++){var s=n[t];s.enumerable=s.enumerable||false;s.configurable=true;"value"in s&&(s.writable=true);Object.defineProperty(e,H(s.key),s)}}function g(e,n,t){n&&S(e.prototype,n);t&&S(e,t);Object.defineProperty(e,"prototype",{writable:false});return e}function N(){N=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e};return N.apply(this,arguments)}function C(e,n){if(typeof e!=="object"||e===null)return e;var t=e[Symbol.toPrimitive];if(t!==void 0){var s=t.call(e,n||"default");if(typeof s!=="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(e)}function H(e){var n=C(e,"string");return typeof n==="symbol"?n:String(n)}var j;var B;(function(e){e[e.Sync=0]="Sync";e[e.Awareness=1]="Awareness";e[e.Auth=2]="Auth";e[e.QueryAwareness=3]="QueryAwareness"})(B||(B={}));var O=function(e,n){console.warn("Permission denied to access "+e.channelName+".\n"+n)};var _=(j={},j[B.Sync]=function(n,t,s,i){e(n,B.Sync);var r=c(t,n,s.doc,s);i&&r===d&&!s.synced&&(s.synced=true)},j[B.QueryAwareness]=function(t,s,i,r,a){e(t,B.Awareness);n(t,f(i.awareness,Array.from(i.awareness.getStates().keys())))},j[B.Awareness]=function(e,n,t){v(t.awareness,r(n),t)},j[B.Auth]=function(e,n,t){w(n,t.doc,(function(e,n){return O(t,n)}))},j);var P=function(){function r(r,a,o,c,d){var u=this;var l=d===void 0?{}:d,v=l.awareness,w=v===void 0?new p(r):v,m=l.disableBc,A=m!==void 0&&m;this.consumer=void 0;this.channel=void 0;this.params=void 0;this.doc=void 0;this.channelName=void 0;this.bcChannelName=void 0;this.awareness=void 0;this.bcconnected=void 0;this.disableBc=void 0;this._synced=void 0;this.bcSubscriber=function(e,n){if(n!==u){var i=u.process(new Uint8Array(e),false);t(i)>1&&y(u.bcChannelName,s(i),u)}};this.updateHandler=function(n,t){if(t!==u){var r=i();e(r,B.Sync);h(r,n);u.send(s(r))}};this.unloadHandler=function(){b(u.awareness,[u.doc.clientID],"window unload")};this.awarenessUpdateHandler=function(t,r){var a=t.added,o=t.updated,c=t.removed;var d=a.concat(o).concat(c);var h=i();e(h,B.Awareness);n(h,f(u.awareness,d));u.send(s(h),{whisper:true})};this.consumer=a;this.channelName=o;this.bcChannelName=o+"_"+Object.entries(c).map((function(e,n){return e+"-"+n})).join("_");this.params=c;this.doc=r;this.awareness=w;this.bcconnected=false;this.disableBc=A;this._synced=false;this.doc.on("update",this.updateHandler);typeof window!=="undefined"?window.addEventListener("unload",this.unloadHandler):typeof process!=="undefined"&&process.on("exit",this.unloadHandler);w.on("update",this.awarenessUpdateHandler);this.connect()}var c=r.prototype;c.destroy=function(){this.disconnect();typeof window!=="undefined"?window.removeEventListener("unload",this.unloadHandler):typeof process!=="undefined"&&process.off("exit",this.unloadHandler);this.awareness.off("update",this.awarenessUpdateHandler);this.doc.off("update",this.updateHandler)};c.send=function(e,n){var t=n===void 0?{}:n,s=t.whisper,i=s!==void 0&&s;var r=U(e);if(i&&I(this.channel))this.channel.whisper({update:r});else{var a;(a=this.channel)==null?void 0:a.send({update:r})}this.bcconnected&&y(this.bcChannelName,e,this)};c.process=function(e,n){var t=a(e);var s=i();var r=o(t);var c=_[r];c?c(s,t,this,n,r):console.error("Unable to compute message");return s};c.subscribe=function(){var r=this;this.synced=false;this.channel=this.consumer.subscriptions.create(N({channel:this.channelName},this.params),{received:function(e){var n=e.update;var i=D(n);var a=r.process(i,true);t(a)>1&&r.send(s(a))},disconnected:function(){r.synced=false;b(r.awareness,Array.from(r.awareness.getStates().keys()).filter((function(e){return e!==r.doc.clientID})),r)},connected:function(){var t=i();e(t,B.Sync);u(t,r.doc);r.send(s(t));if(r.awareness.getLocalState()!==null){var a=i();e(a,B.Awareness);n(a,f(r.awareness,[r.doc.clientID]));r.send(s(a))}}})};c.connectBc=function(){if(!this.disableBc){if(!this.bcconnected){m(this.bcChannelName,this.bcSubscriber);this.bcconnected=true}var t=i();e(t,B.Sync);u(t,this.doc);y(this.bcChannelName,s(t),this);var r=i();e(r,B.Sync);l(r,this.doc);y(this.bcChannelName,s(r),this);var a=i();e(a,B.QueryAwareness);y(this.bcChannelName,s(a),this);var o=i();e(o,B.Awareness);n(o,f(this.awareness,[this.doc.clientID]));y(this.bcChannelName,s(o),this)}};c.disconnectBc=function(){var t=i();e(t,B.Awareness);n(t,f(this.awareness,[this.doc.clientID],new Map));this.send(s(t));if(this.bcconnected){A(this.bcChannelName,this.bcSubscriber);this.bcconnected=false}};c.disconnect=function(){var e;this.disconnectBc();(e=this.channel)==null?void 0:e.unsubscribe();this.channel!=null&&(this.channel=void 0)};c.connect=function(){if(this.channel==null){this.subscribe();this.connectBc()}};g(r,[{key:"synced",get:function(){return this._synced},set:function(e){this._synced!==e&&(this._synced=e)}}]);return r}();function U(e){var n=Array.from(e,(function(e){return String.fromCharCode(e)})).join("");return btoa(n)}function D(e){return Uint8Array.from(atob(e),(function(e){return e.charCodeAt(0)}))}function I(e){return e!==void 0&&"whisper"in e&&typeof e.whisper==="function"}export{P as WebsocketProvider};

