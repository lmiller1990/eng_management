<% content_for :title, "Rubrics" %>

<div class="w-full mb-8">
  <h1 class="text-3xl font-bold"><%= @rubric.name %></h1>
</div>

<% @rubric.categories.each do |category| %>
  <div class="mb-12">
    <h2 class="text-2xl font-semibold mb-4"><%= category.name %></h2>

    <%
      dimensions = category.dimensions
      job_titles = dimensions.flat_map(&:job_titles).uniq.sort_by(&:name)
      expectations_by_dimension_and_job = dimensions.each_with_object({}) do |dim, hash|
        hash[dim.id] = dim.expectations.index_by { |exp| exp.job_title_id }
      end
    %>

    <% if dimensions.any? && job_titles.any? %>
      <table class="w-full border-collapse border border-gray-300">
        <thead>
          <tr class="bg-gray-100">
            <th class="border border-gray-300 px-4 py-2 text-left font-semibold">Dimension</th>
            <% job_titles.each do |job_title| %>
              <th class="border border-gray-300 px-4 py-2 text-left font-semibold"><%= job_title.name %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% dimensions.each do |dimension| %>
            <tr>
              <td class="border border-gray-300 px-4 py-2 font-semibold"><%= dimension.name %></td>
              <% job_titles.each do |job_title| %>
                <% expectation = expectations_by_dimension_and_job[dimension.id][job_title.id] %>
                <td class="border border-gray-300 px-4 py-2">
                  <% if expectation %>
                    <%= expectation.description %>
                  <% end %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-gray-500">No dimensions or job titles defined for this category.</p>
    <% end %>
  </div>
<% end %>
