<div
  data-controller="rubric-evaluation"
  data-rubric-evaluation-evaluation-id-value="<%= @evaluation.id %>"
>
  <!-- Open the modal using ID.showModal() method -->
  <dialog
    id="expectation_modal"
    class="modal"
    data-rubric-evaluation-target="modal"
  >
    <div class="modal-box">
      <h3 class="text-lg font-bold">Enter Notes</h3>
      <turbo-frame id="rubric_evaluation_form" data-rubric-evaluation-target="frame">
        <!-- Form will load here dynamically -->
      </turbo-frame>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <div class="w-full mb-8">
    <h1 class="text-3xl font-bold"><%= @rubric.name %></h1>
  </div>
  <div class="flex justify-end">

    <button class="btn" popovertarget="popover-1" style="anchor-name:--anchor-1">
      Toggle Levels
    </button>
    <ul
      class="
        dropdown menu w-52 rounded-box bg-base-100 shadow-sm dropdown-bottom
        dropdown-end
      "
      popover
      id="popover-1"
      style="position-anchor:--anchor-1"
    >
      <% @rubric.job_titles.each do |job_title| %>
        <li>
          <label>
            <input
              type="checkbox"
              checked="checked"
              class="checkbox"
              data-class="job-filter"
              data-action="change->rubric-evaluation#toggleColumn"
              id="<%= job_title.name.parameterize.underscore %>"
            />
            <%= job_title.name %>
          </label>
        </li>
      <% end %>
    </ul>

  </div>

  <% all_dimensions = @rubric.categories.flat_map(&:dimensions)
  job_titles = all_dimensions.flat_map(&:job_titles).uniq.sort_by(&:order)
  expectations_by_dimension_and_job =
    all_dimensions.each_with_object({}) do |dim, hash|
      hash[dim.id] = dim.expectations.index_by { |exp| exp.job_title_id }
    end %>

  <% if all_dimensions.any? && job_titles.any? %>
    <div class="overflow-x-auto">
      <table class="table table-xs">
        <thead>
          <tr>
            <th>Dimension</th>
            <% job_titles.each do |job_title| %>
              <th data-job-name="<%= job_title.name.parameterize.underscore %>"><%= job_title.name %></th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @rubric.categories.each do |category| %>
            <% dimensions = category.dimensions %>
            <% if dimensions.any? %>
              <tr>
                <td colspan="<%= job_titles.length + 1 %>" class="font-bold bg-base-200 py-4">
                  <%= category.name %>
                </td>
              </tr>
              <% dimensions.each do |dimension| %>
                <tr class="hover:bg-base-300">
                  <td><%= dimension.name %></td>
                  <% job_titles.each do |job_title| %>
                    <% expectation = expectations_by_dimension_and_job[dimension.id][job_title.id] %>
                    <td
                      data-job-name="<%= job_title.name.parameterize.underscore %>"
                      data-dimension-id="<%= dimension.id %>"
                      data-job-title-id="<%= job_title.id %>"
                      data-action="click->rubric-evaluation#openCell"
                      class="cursor-pointer p-4"
                    >
                      <% if expectation %>
                        <%= expectation.description %>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="text-gray-500">No dimensions or job titles defined for this rubric.</p>
  <% end %>

</div>
