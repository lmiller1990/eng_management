<style>
  .dimension-column {
    width: 150px;
  }

  .job-column {
    width: 250px;
  }
</style>

<div
  data-controller="rubric-evaluation"
  data-rubric-evaluation-evaluation-id-value="<%= @evaluation.id %>"
>
  <!-- Open the modal using ID.showModal() method -->
  <dialog
    id="expectation_modal"
    class="modal"
    data-rubric-evaluation-target="modal"
  >
    <div class="modal-box">
      <h3 class="text-lg font-bold pb-4">Level & Feedback</h3>
      <turbo-frame id="rubric_evaluation_form" data-rubric-evaluation-target="frame">
        <!-- Form will load here dynamically -->
      </turbo-frame>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <div class="w-full mb-8">
    <h1 class="text-3xl font-bold"><%= @rubric.name %></h1>
  </div>
  <div class="flex justify-end">

    <button class="btn" popovertarget="popover-1" style="anchor-name:--anchor-1">
      Toggle Levels
    </button>
    <ul
      class="
        dropdown menu w-52 rounded-box bg-base-100 shadow-sm dropdown-bottom
        dropdown-end
      "
      popover
      id="popover-1"
      style="position-anchor:--anchor-1"
    >
      <% @rubric.job_titles.each do |job_title| %>
        <li>
          <label>
            <input
              type="checkbox"
              checked="checked"
              class="checkbox"
              data-class="job-filter"
              data-action="change->rubric-evaluation#toggleColumn"
              id="<%= job_title.name.parameterize.underscore %>"
            />
            <%= job_title.name %>
          </label>
        </li>
      <% end %>
    </ul>

  </div>

  <% all_dimensions = @rubric.categories.flat_map(&:dimensions)
  job_titles = all_dimensions.flat_map(&:job_titles).uniq.sort_by(&:order)
  expectations_by_dimension_and_job =
    all_dimensions.each_with_object({}) do |dim, hash|
      hash[dim.id] = dim.expectations.index_by { |exp| exp.job_title_id }
    end %>

  <% if all_dimensions.any? && job_titles.any? %>
    <div class="rounded-lg overflow-hidden">
      <!-- Header Row -->
      <div class="flex bg-base-200 border-b border-base-300">
        <div
          class="
            dimension-column p-3 font-semibold text-sm border-r border-base-300
          "
        >
          Dimension
        </div>
        <% job_titles.each do |job_title| %>
          <div
            class="
              job-column p-3 font-semibold text-sm border-r border-base-300 last:border-r-0
            "
            data-job-name="<%= job_title.name.parameterize.underscore %>"
          >
            <%= job_title.name %>
          </div>
        <% end %>
      </div>
      <!-- Categories -->
      <% @rubric.categories.each do |category| %>
        <% dimensions = category.dimensions %>
        <% if dimensions.any? %>
          <!-- Category Header -->
          <div class="flex bg-base-200 border-b border-base-300">
            <div class="p-4 font-bold text-base w-full">
              <%= category.name %>
            </div>
          </div>
          <!-- Dimension Rows -->
          <% dimensions.each do |dimension| %>
            <div class="flex border-b border-base-300 last:border-b-0">
              <!-- Dimension Name -->
              <div
                class="
                  dimension-column p-3 font-medium text-sm bg-base-100 border-r border-base-300
                "
              >
                <%= dimension.name %>
              </div>
              <!-- Expectations for each Job Title -->
              <% job_titles.each do |job_title| %>
                <% expectation = expectations_by_dimension_and_job[dimension.id][job_title.id] %>
                <div
                  class="
                    job-column p-3 bg-base-100 cursor-pointer hover:bg-base-200 transition-colors
                    text-sm border-r border-base-300 last:border-r-0
                  "
                  data-job-name="<%= job_title.name.parameterize.underscore %>"
                  data-dimension-id="<%= dimension.id %>"
                  data-job-title-id="<%= job_title.id %>"
                  data-action="click->rubric-evaluation#openCell"
                >
                  <% if expectation %>
                    <%= expectation.description %>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500">No dimensions or job titles defined for this rubric.</p>
  <% end %>

</div>
